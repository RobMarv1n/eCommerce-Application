name: Lighthouse CI

on:
  pull_request:

jobs:
  lhci:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - run: npm ci
      - run: npm install -g @lhci/cli@0.15.x

      - name: Run Lighthouse CI
        run: lhci autorun

      - name: Extract Lighthouse links and scores
        id: lighthouse_scores
        run: |
          {
            echo "scores<<EOF"
            echo "ðŸ“Š **Lighthouse Audit Report:**"
            echo ""
            echo "| Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° | Performance | Accessibility | Best Practices | SEO |"
            echo "|----------|-------------|----------------|----------------|-----|"

            find lighthouseci -name "*.report.json" | while read json_file; do
              url=$(jq -r '.finalUrl' "$json_file")
              perf=$(jq -r '.categories.performance.score' "$json_file")
              acc=$(jq -r '.categories.accessibility.score' "$json_file")
              bp=$(jq -r '.categories["best-practices"].score' "$json_file")
              seo=$(jq -r '.categories.seo.score' "$json_file")

              path=$(echo "$url" | cut -d '/' -f4-)
              [ -z "$path" ] && path="/" || path="/$path"

              echo "| [$path]($url) | $perf | $acc | $bp | $seo |"
            done

            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Comment PR with Lighthouse Report
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: lighthouse-report
          message: |
            ${{ steps.lighthouse_scores.outputs.scores }}
