name: Lighthouse CI

on:
  pull_request:
    branches: [main]

permissions:
  pull-requests: write
  contents: read

jobs:
  lighthouse:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Install Lighthouse CI CLI
        run: npm install -g @lhci/cli

      - name: Run Lighthouse CI (URLs from .lighthouserc.js)
        run: lhci autorun --upload.target=filesystem

      - name: Extract Lighthouse scores
        id: lighthouse-scores
        run: |
          echo "scores<<EOF" >> $GITHUB_OUTPUT
          echo "| Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° | Performance | Accessibility | Best Practices | SEO |" >> $GITHUB_OUTPUT
          echo "|----------|-------------|---------------|----------------|-----|" >> $GITHUB_OUTPUT

          for file in $(find .lighthouseci -name "*.report.json"); do
            url=$(jq -r '.finalUrl' "$file")
            perf=$(jq -r '.categories.performance.score // 0' "$file")
            acc=$(jq -r '.categories.accessibility.score // 0' "$file")
            bp=$(jq -r '.categories["best-practices"].score // 0' "$file")
            seo=$(jq -r '.categories.seo.score // 0' "$file")

            echo "| $url | $perf | $acc | $bp | $seo |" >> $GITHUB_OUTPUT
          done

          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR with Lighthouse Report
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ðŸ§­ **Lighthouse Audit Report:**

            ${{ steps.lighthouse-scores.outputs.scores }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
