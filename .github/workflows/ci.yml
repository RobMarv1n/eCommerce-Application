name: Lighthouse CI

on:
  pull_request:
    branches:
      - '**'

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - run: npm ci
      - run: npm install -g @lhci/cli@0.15.x

      - name: Run Lighthouse CI
        run: lhci autorun

      - name: Extract Lighthouse links and scores
        id: scores
        run: |
          echo "scores=🕵️ Lighthouse Audit Report:" >> $GITHUB_OUTPUT
          echo "" >> scores.txt

          for json_file in lighthouseci/*.json; do
            url=$(jq -r '.finalUrl' "$json_file")
            perf=$(jq -r '.categories.performance.score' "$json_file")
            acc=$(jq -r '.categories.accessibility.score' "$json_file")
            bp=$(jq -r '.categories["best-practices"].score' "$json_file")
            seo=$(jq -r '.categories.seo.score' "$json_file")

            path=$(echo "$url" | cut -d '/' -f4-)
            [ -z "$path" ] && path="/" || path="/$path"

            echo "| [$path]($url) | ${perf} | ${acc} | ${bp} | ${seo} |" >> scores.txt
          done

          echo "" >> scores.txt
          echo "| Page | Perf | Access | BestPractices | SEO |" > table.txt
          echo "|------|------|--------|---------------|-----|" >> table.txt
          cat scores.txt >> table.txt

          echo "scores<<EOF" >> $GITHUB_OUTPUT
          cat table.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR with Lighthouse Report
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: '${{ steps.scores.outputs.scores }}'
